<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Equipes</title>
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f4f9; }
        .container { max-width: 95%; margin: auto; background: white; padding: 2em; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        
        /* --- ESTILOS DO FORMULÁRIO (MELHORADOS) --- */
        form { 
            margin-bottom: 2em; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 1.5em; /* Aumenta o espaçamento */
            align-items: flex-end; 
        }
        .form-group { 
            display: flex; 
            flex-direction: column; 
            min-width: 120px; /* Ajuda no alinhamento */
        }
        .radio-group { display: flex; gap: 1em; align-items: center; padding-top: 0.5em; }
        label { margin-bottom: 0.3em; font-size: 0.9em; color: #555; }
        select, input, button { padding: 0.8em; font-size: 1em; border-radius: 4px; border: 1px solid #ccc; }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; }
        /* Estilo do botão desativado (para feedback de loading) */
        button:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        .summary-table { border: 1px solid #eee; padding: 1.5em; border-radius: 8px; margin-top: 2em;}
        
        /* --- MELHORIA: TABELA RESPONSIVA --- */
        .table-wrapper {
            overflow-x: auto; /* Permite scroll horizontal em ecrãs pequenos */
            width: 100%;
            margin-top: 1em;
        }
        .table-wrapper table { 
            width: 100%; 
            border-collapse: collapse; 
            /* margin-top: 1em; (movido para o wrapper) */
        }
        
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        th { background-color: #f2f2f2; }
        details { cursor: pointer; }
        summary { font-weight: bold; }

        /* --- MELHORIA: ESTILO PARA MENSAGEM DE ERRO --- */
        .error-box {
            background-color: #fff0f0;
            border: 1px solid #e0b0b0;
            color: #a00;
            padding: 1.5em;
            border-radius: 8px;
            margin-top: 2em;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Análise de Equipes</h1>
        
        <form action="/" method="get">
            <div class="form-group">
                <label for="mes">Mês:</label>
                <select name="mes" id="mes">{% for mes in meses %}<option value="{{ mes.num }}" {% if mes.num == mes_selecionado %}selected{% endif %}>{{ mes.nome }}</option>{% endfor %}</select>
            </div>
            <div class="form-group">
                <label for="ano">Ano:</label>
                <input type="number" name="ano" id="ano" value="{{ ano_selecionado }}" style="width: 80px;">
            </div>
            <div class="form-group">
                <label>Visão Geral:</label>
                <div class="radio-group">
                    <input type="radio" id="view_fixas" name="view_mode" value="equipas_fixas" {% if view_mode == 'equipas_fixas' %}checked{% endif %}>
                    <label for="view_fixas">Equipas Fixas</label>
                    <input type="radio" id="view_resumo" name="view_mode" value="resumo_detalhado" {% if view_mode == 'resumo_detalhado' %}checked{% endif %}>
                    <label for="view_resumo">Detalhado</label>
                </div>
            </div>
            <button type="submit">Gerar</button>
        </form>

        {% if error_message %}
            <div class="error-box">
                <p><strong>{{ error_message }}</strong></p>
            </div>
        
        {% elif dashboard_equipas %}
            <div class="summary-table">
                <h2>Dashboard de Equipas Fixas para {{ meses[mes_selecionado-1].nome }}/{{ ano_selecionado }}</h2>
                
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>MOTORISTA (VIAGENS)</th>
                                <th>COD</th>
                                <th>MOTORISTA 2</th>
                                <th>COD 2</th>
                                <th>AJUDANTE 1</th>
                                <th>CÓDJ. 1</th>
                                <th>AJUDANTE 2</th>
                                <th>CÓDJ. 2</th>
                                <th>AJUDANTE 3</th>
                                <th>CÓDJ. 3</th>
                                <th>OBSERVAÇÕES (VISITANTES)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for linha in dashboard_equipas %}
                            <tr>
                                <td><strong>{{ linha.get('MOTORISTA', '') }}</strong></td>
                                <td>{{ linha.get('COD', '') }}</td>
                                <td>{{ linha.get('MOTORISTA_2', '') }}</td>
                                <td>{{ linha.get('COD_2', '') }}</td>
                                <td>{{ linha.get('AJUDANTE_1', '') }}</td>
                                <td>{{ linha.get('CODJ_1', '') }}</td>
                                <td>{{ linha.get('AJUDANTE_2', '') }}</td>
                                <td>{{ linha.get('CODJ_2', '') }}</td>
                                <td>{{ linha.get('AJUDANTE_3', '') }}</td>
                                <td>{{ linha.get('CODJ_3', '') }}</td>
                                <td>
                                    {% if linha.get('VISITANTES') %}
                                    <details>
                                        <summary>{{ linha.get('VISITANTES')|length }} Visitante(s)</summary>
                                        {% for visitante in linha.get('VISITANTES') %}
                                            {{ visitante }}<br>
                                        {% endfor %}
                                    </details>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% elif resumo_viagens %}
            <div class="summary-table">
                <h2>Resumo Detalhado para {{ meses[mes_selecionado-1].nome }}/{{ ano_selecionado }}</h2>
                
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>MAPA</th>
                                <th>MOTORISTA</th>
                                <th>COD</th>
                                <th>MOTORISTA 2</th>
                                <th>COD 2</th>
                                <th>AJUDANTE 1</th>
                                <th>CODJ_1</th>
                                <th>AJUDANTE 2</th>
                                <th>CODJ_2</th>
                                <th>AJUDANTE 3</th>
                                <th>CODJ_3</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for viagem in resumo_viagens %}
                            <tr>
                                <td>{{ viagem.get('MAPA', '') }}</td>
                                <td>{{ viagem.get('MOTORISTA', '') }}</td>
                                <td>{{ viagem.get('COD', '') }}</td>
                                <td>{{ viagem.get('MOTORISTA_2', '') }}</td>
                                <td>{{ viagem.get('COD_2', '') }}</td>
                                <td>{{ viagem.get('AJUDANTE_1', '') }}</td>
                                <td>{{ viagem.get('CODJ_1', '') }}</td>
                                <td>{{ viagem.get('AJUDANTE_2', '') }}</td>
                                <td>{{ viagem.get('CODJ_2', '') }}</td>
                                <td>{{ viagem.get('AJUDANTE_3', '') }}</td>
                                <td>{{ viagem.get('CODJ_3', '') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        
        {% else %}
             <div class="summary-table">
                <p>Nenhum dado encontrado para a seleção atual.</p>
            </div>
        {% endif %}
    </div>

    <script>
        document.querySelector('form').addEventListener('submit', function() {
            var btn = document.querySelector('button[type="submit"]');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'A carregar...';
            }
        });
    </script>

</body>
</html>